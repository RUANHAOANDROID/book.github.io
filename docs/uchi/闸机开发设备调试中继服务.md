---
title: 闸机开发设备调试-中继服务
categories: -技术
tags: 
- Android
- Kotlin
- 硬件
date: 2022-05-12 17:43
---
# 闸机开发设备调试-中继服务

中继服务是具备网口的主机可以是Windows或者Linux设备，通过连接单片机的网口且需要单片机到主控的连接进行开发

## 1.接线

### 1.1中继服务接入单片机控制板

- 仅仅需要网口相连或者接入同一个路由器（具体再后续说明）

### 1.2单片机控制板接入闸机主控

目前为右开（左开暂且不考虑）

- IR1接入主控板右计数
- GND接入闸机主控GND④
- K1接入闸机主控右开
- com⑩接入闸机主控12V

## 2.网络配置

### 2.1 通信方式
闸机通过RJ45 网口UDP方式与中继服务互相通信。
### 2.2 闸机配置说明
闸机配置IP通过**Micro USB数据线(市面叫做老Android线)**以连接U盘的形式变更**IP.ini**文件，变更后重启闸机生效

> IP配置示例说明：

```config
IP_Addr:192.168.0.217			闸机IP地址接受开闸UDP报文
Sub_Mask:255.255.255.0			闸机子网掩码
Gateway_IP:192.168.0.250		网关IP
MAC:0c:29:ab:7c:00:17			闸机MAC地址，MAC地址最后两位对应IP_Addr最后两位
PORT:60066						闸机监听开闸报文的端口号
D_IP_Addr:192.168.0.8			中继服务IP，需要在同一个网段且网关相同
D_PORT:60000					中继服务器监听刷卡和过闸报文端口
```

## 3.报文的定义

报文目前分为刷票、开闸和过闸以UDP方式发送

### 3.1刷票

- 方向：闸机 -> 中继

- 示例：

  ```
  $F384605470533333459544638111/@32861212152363<MjAwMDAwMDAwNTIwMjItMDMtMTYyMDIyLTEyLTMx>\@$E
  ```

### 3.2开闸

- 方向：中继服务 -> 闸机

- 示例：

  ```
  $F384605470533333459544638111A01000/&\&$E
  ```

  


### 3.3 过闸

- 方向 ：闸机->中继

- 示例：

  ```
   $F384605470533333459544638P21/@ok\@$E
  ```
> 报文定义参照最新的《网络转接板协议》



## 4.接入调试

### 4.1 接交换或路由

  设备LAN口下连接，闸机和中继服务配置相同的网关不同的IP

### 4.2 中继和闸机直连接

  网线直连，设置不变

## 5.闸机接入上级路由实现无线调试

受限于物理网口无法接入，为方便调试接入无线设备作为子路由，子路由以无线方式接入到上级路由（中继和开发电脑在上级主路由的LAN口下）。

### 5.1 中继网络配置

```
IP：192.168.0.8
子网掩码：255.255.255.0
默认网关: 192.168.0.1		
监听端口号：60000
```
### 5.2 子路由网络核心配置

```
WAN IP:192.168.0.116			
LAN 网关：192.168.1.1			
端口转发：60066 -> 192.168.1.217	
```
### 5.3 闸机网络配置

```
IP_Addr:192.168.1.217	
Sub_Mask:255.255.255.0	       
Gateway_IP:192.168.1.1		
MAC:0c:29:ab:7c:00:17		
PORT:60066				 
D_IP_Addr:192.168.0.8	    注意：这里是中继服务IP，不在同一个LAN下
D_PORT:60000			

```